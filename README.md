# Dev Skin

A desktop application built with Electron, React, and Monaco Editor featuring an AI Assistant sidebar with RAG capabilities, MCP-compatible tools, and patch application functionality.

## Purpose

Dev Skin is an AI-powered code editor that helps developers:
- **Generate code patches** using LLM with RAG (Retrieval-Augmented Generation) context
- **Apply patches safely** with preview and confirmation workflows
- **Run tests** directly from the editor
- **Create pull requests** with automated branch and commit management
- **Edit code** with a full-featured Monaco editor

The application uses a secure architecture with context isolation, sandboxed test execution, and dry-run modes for safety.

## Monorepo Structure

```
dev-skin/
├── electron/          # Electron main process
│   ├── main.js        # Main entry point
│   ├── preload.js     # Preload script
│   └── services/      # MCP services
├── renderer/          # React + Vite app
│   ├── src/
│   │   ├── main.jsx   # React entry
│   │   ├── App.jsx    # Main app component
│   │   └── components/
│   └── vite.config.js
├── adapter/           # Express adapter service
│   └── index.js       # LLM + RAG endpoints
├── mcp-server/        # MCP protocol server
│   ├── manifest.json  # Tool definitions
│   └── server.js      # MCP server
└── package.json       # Root workspace config
```

## Prerequisites

- **Node.js 18+** and npm
- **Git** (for PR creation feature)
- **OpenAI API key** (for LLM functionality) - Get one at https://platform.openai.com/api-keys

## Quick Start

### 1. Install Dependencies

```bash
npm install
```

Or use the bootstrap script:
```bash
npm run bootstrap
```

### 2. Set Environment Variables

Create a `.env` file in the root directory or export environment variables:

```bash
# Required for LLM functionality
export OPENAI_API_KEY=your-openai-api-key-here

# Optional: Customize LLM endpoint and model
export LLM_ENDPOINT=https://api.openai.com/v1/chat/completions
export LLM_MODEL=gpt-4

# Optional: Disable dry-run mode for PR creation (default: enabled for safety)
export DRY_RUN=false
```

### 3. Start Development Stack

```bash
npm run start:dev
```

This command:
1. Starts the **renderer** dev server (Vite) on http://localhost:5173
2. Starts the **adapter** service on http://localhost:8000
3. Starts the **MCP server** on http://localhost:8001
4. Waits for all services to be ready
5. Launches **Electron** app automatically

The app will open in a new window. You can stop all services with `Ctrl+C`.

## Running Tests

Run the test suite:

```bash
npm test
```

This will:
- Start the adapter service in test mode
- Run the assistant flow test (`test/test-assist.spec.js`)
- Test POST /assist endpoint with a sample instruction
- Validate response contains patch and expected content
- Clean up and stop the adapter

### Test Details

The test suite uses **Mocha** and **Chai**. Tests:
- Spawn the adapter as a child process
- Wait for the service to be ready
- Make API calls and validate responses
- Clean up processes after completion

## Apply Patch Flow

The "Apply Patch" feature allows you to safely apply code changes generated by the AI assistant.

### How It Works

1. **Generate Patch**: 
   - Enter an instruction in the assistant panel (e.g., "Add error handling to the function")
   - Click "✨ Generate Patch" or press Enter
   - The adapter service calls the LLM with RAG context
   - A patch is generated and displayed in the chat

2. **Preview Patch**:
   - The generated patch appears in a preview panel below the chat
   - Review the patch structure (unified diff or JSON format)
   - Check which files will be modified

3. **Apply Patch** (Two Modes):

   **Dry Run Mode (Default)**:
   - Click "✅ Apply Patch" button
   - The system shows what would be changed
   - **No actual file modifications are made**
   - Safe for testing and review

   **Confirmation Mode**:
   - After reviewing the patch preview
   - Click "✅ Apply Patch" again to confirm
   - The patch is applied to the workspace files
   - Edits are applied in reverse order (end to start) to prevent position shifts
   - Success/error message is displayed

### Patch Format

Patches can be in two formats:

1. **Unified Diff Format**:
   ```diff
   --- a/src/file.js
   +++ b/src/file.js
   @@ -1,3 +1,5 @@
    function example() {
   +  try {
       return true;
   +  } catch (error) {
   +    return false;
   +  }
    }
   ```

2. **JSON Format** (for multiple files):
   ```json
   {
     "file": "src/file.js",
     "edits": [
       {
         "start": 0,
         "end": 10,
         "replacement": "// New code\n"
       }
     ]
   }
   ```

### Safety Features

- **Dry-run by default**: Patches are previewed before application
- **Validation**: File existence and edit range validation
- **Reverse order application**: Edits applied from end to start to prevent position shifts
- **Error handling**: Clear error messages for invalid patches

## Security

### API Key Storage

**⚠️ Never commit API keys to version control**

Dev Skin supports secure API key storage using OS keychains:

#### Using OS Keychain (Recommended)

**macOS:**
```bash
# Install keytar (optional dependency)
npm install keytar

# Store key via API
curl -X POST http://localhost:8000/api/keychain \
  -H "Content-Type: application/json" \
  -d '{"key": "sk-your-api-key"}'

# Keys are stored in macOS Keychain Access
# View: Keychain Access app > search "dev-skin"
```

**Windows:**
```bash
npm install keytar

# Store key via API
curl -X POST http://localhost:8000/api/keychain \
  -H "Content-Type: application/json" \
  -d '{"key": "sk-your-api-key"}'

# Keys stored in Windows Credential Manager
# View: Control Panel > Credential Manager > Windows Credentials
```

**Linux:**
```bash
# Install keytar and libsecret
sudo apt-get install libsecret-1-dev  # Ubuntu/Debian
# or
sudo yum install libsecret-devel      # RHEL/CentOS

npm install keytar

# Store key via API
curl -X POST http://localhost:8000/api/keychain \
  -H "Content-Type: application/json" \
  -d '{"key": "sk-your-api-key"}'

# Keys stored via Secret Service (GNOME Keyring, KWallet, etc.)
```

#### Fallback: Environment Variables

If keychain is not available:
```bash
# Use .env file (not committed)
echo "OPENAI_API_KEY=sk-..." > .env

# Or export in your shell profile
export OPENAI_API_KEY=sk-...
```

**Keychain Management:**
- `POST /api/keychain` - Store API key in keychain
- `GET /api/keychain` - Check keychain status
- `DELETE /api/keychain` - Delete stored key

### Sandbox Test Execution

Test execution uses a hardened sandbox with multiple security layers:

**Per-Process Sandbox:**
- **Isolated child processes**: Tests run in separate processes
- **Timeout protection**: 60-second timeout (configurable)
- **Memory limits**: 512MB max memory per process
- **Output buffer limits**: 10MB max output to prevent memory exhaustion
- **Resource monitoring**: Process resource usage tracking

**Command Allowlist:**
- **Whitelist-only execution**: Only pre-approved commands can run
- **Dangerous pattern blocking**: Blocks commands like `rm -rf`, `format`, `sudo`, etc.
- **No shell redirection**: Prevents piping, redirection, and background execution
- **Git command restrictions**: Only safe git operations allowed

**Allowed Commands:**
- `npm test` - Run tests
- `git status`, `git diff`, `git log` - Read-only git operations
- `git checkout -b <branch>` - Branch creation only
- `git add .` - Stage changes
- `git commit -m "<message>"` - Commit (requires explicit confirmation)
- `git push -u origin <branch>` - Push (requires explicit confirmation)

**Blocked Patterns:**
- File deletion: `rm -rf`, `rm -r`, `del /s`
- System commands: `format`, `mkfs`, `shutdown`, `reboot`
- Privilege escalation: `sudo`
- Shell injection: `| sh`, `| bash`, `> /dev/null`
- Arbitrary downloads: `curl ... | sh`, `wget ... | sh`

### Explicit Confirmation for Git Operations

**Security Requirement:**
- **Commit operations**: Require `confirm: true` in request body
- **Push operations**: Require `confirm: true` in request body
- **Dry-run by default**: All operations default to preview mode

**Example:**
```json
{
  "branchName": "feature/new-feature",
  "commitMessage": "Add new feature",
  "confirm": true  // Required for actual execution
}
```

Without `confirm: true`, the operation returns a preview only.

### Path Validation

- **Directory traversal prevention**: All paths are resolved and validated
- **Repository validation**: Ensures path exists and is a valid git repository
- **File existence checks**: Validates files exist before operations

### Additional Security Measures

1. **Context Isolation**: Electron uses `contextIsolation: true` to prevent renderer from accessing Node.js directly
2. **No Node Integration**: Renderer cannot use `require()` or access filesystem directly
3. **Controlled API Surface**: Only specific functions exposed via `contextBridge`
4. **Request Logging**: All adapter requests are logged for audit trails
5. **Optional Authentication**: MCP server supports token-based authentication
6. **Command Validation**: All commands validated against allowlist before execution
7. **Resource Limits**: Memory and CPU limits prevent resource exhaustion attacks

### Security Best Practices

1. **Use OS Keychain**: Store API keys in keychain, not environment variables
2. **Review Patches**: Always review generated patches before applying
3. **Use Dry-Run**: Keep `DRY_RUN=true` in development
4. **Explicit Confirmation**: Always require `confirm: true` for destructive operations
5. **Monitor Logs**: Review adapter logs regularly for suspicious activity
6. **Limit Network Access**: Run adapter on localhost only in production
7. **Regular Updates**: Keep dependencies updated for security patches

## Building and Packaging

### Build Renderer

Build the React app for production:

```bash
npm run build
```

This compiles the renderer to `renderer/dist/` for use in production Electron builds.

### Package Application

Package the app for distribution using electron-builder:

```bash
npm run package
```

**electron-builder Configuration:**

The packaging uses electron-builder with the following configuration (can be added to `package.json`):

```json
{
  "build": {
    "appId": "com.devskin.app",
    "productName": "Dev Skin",
    "directories": {
      "output": "dist-electron"
    },
    "files": [
      "electron/**/*",
      "renderer/dist/**/*",
      "adapter/**/*",
      "mcp-server/**/*",
      "package.json"
    ],
    "win": {
      "target": ["nsis"],
      "icon": "build/icon.ico"
    },
    "mac": {
      "target": ["dmg"],
      "icon": "build/icon.icns",
      "category": "public.app-category.developer-tools"
    },
    "linux": {
      "target": ["AppImage", "deb"],
      "icon": "build/icon.png",
      "category": "Development"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true
    }
  }
}
```

**Build Scripts:**

- `npm run build` - Builds renderer for production
- `npm run package` - Packages Electron app for distribution
- `npm run package:win` - Windows-specific build (if configured)
- `npm run package:mac` - macOS-specific build (if configured)
- `npm run package:linux` - Linux-specific build (if configured)

## Individual Services

### Renderer (Vite Dev Server)
```bash
npm run dev --workspace=renderer
```
Runs on http://localhost:5173

### Adapter Service
```bash
npm run start --workspace=adapter
```
Runs on http://localhost:8000

### MCP Server
```bash
npm run start --workspace=mcp-server
```
Runs on http://localhost:8001

### Electron
```bash
npm run start --workspace=electron
```
Launches the Electron app (loads renderer from dev server or built files)

## Configuration

### Adapter Service

Environment variables:
- `OPENAI_API_KEY` or `LLM_API_KEY`: **Required** for LLM functionality
- `LLM_ENDPOINT`: LLM API endpoint (default: `https://api.openai.com/v1/chat/completions`)
- `LLM_MODEL`: Model name (default: `gpt-4`)
- `PORT`: Server port (default: `8000`)
- `DRY_RUN`: Set to `false` to disable dry-run mode for PR creation (default: `true`)

### MCP Server

Environment variables:
- `ADAPTER_URL`: Adapter service URL (default: `http://localhost:8000`)
- `PORT`: Server port (default: `8001`)
- `MCP_TOKEN`: Optional API token for authentication
- `MCP_AUTH_ENABLED`: Set to `true` to enable token authentication

## Architecture

### Electron Package (`/electron`)

- **main.js**: Main Electron process, handles window creation and IPC
- **preload.js**: Exposes safe APIs to renderer via contextBridge
- **services/mcpService.js**: MCP tool implementations (run-tests, create-pr, apply-patch)

### Renderer Package (`/renderer`)

- React application with Monaco Editor
- Assistant panel with chat interface
- Communicates with Electron via `window.devskin.callAdapter()`
- Calls adapter service through HTTP (via Electron preload bridge)

### Adapter Package (`/adapter`)

Express server providing:
- `POST /assist` - Generate patches using LLM with RAG context
- `POST /retrieve` - Vector DB retrieval (placeholder)
- `POST /run-tests` - Execute tests safely
- `POST /create-pr` - Create PR branches (dry-run by default)

### MCP Server Package (`/mcp-server`)

- `GET /manifest` - Serves tool definitions
- `POST /invoke/:toolName` - Invokes tools via adapter service
- Optional authentication via `MCP_TOKEN` environment variable

## Troubleshooting

### Electron window doesn't open
- Check that ports 5173 (renderer), 8000 (adapter), and 8001 (MCP) are available
- Ensure all services started successfully
- Check console for errors
- Verify Node.js version is 18+

### Adapter service not responding
- Verify adapter is running on http://localhost:8000
- Check adapter logs in `adapter/logs/`
- Ensure `OPENAI_API_KEY` is set
- Test with: `curl http://localhost:8000/health`

### Tests don't run
- Ensure test framework is installed in workspace
- Check that `package.json` has test script
- Verify workspace path is correct
- Check Mocha and Chai are installed: `npm install --save-dev mocha chai`

### LLM API errors
- Verify API key is valid and has credits
- Check API rate limits
- Review adapter logs for detailed error messages
- Ensure network connectivity to LLM endpoint

## License

MIT
